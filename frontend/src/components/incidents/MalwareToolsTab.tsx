"use client"

import { useEffect, useState } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input, Textarea } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
    DialogBody,
} from '@/components/ui/dialog'
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select'
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
    GlassTable,
    TableEmpty,
} from '@/components/ui/table'
import { SkeletonTableRow } from '@/components/ui/skeleton'
import { formatDateTime, formatBytes } from '@/lib/utils'
import api from '@/lib/api'
import type { MalwareTool, CompromisedHost } from '@/types'
import {
    Plus,
    Bug,
    Search,
    MoreHorizontal,
    Copy,
    Check,
    FileWarning,
    Wrench,
    ExternalLink,
    Trash2
} from 'lucide-react'
import { useConfirm } from '@/components/ui/confirm-dialog'

interface MalwareToolsTabProps {
    incidentId: string
}

export function MalwareToolsTab({ incidentId }: MalwareToolsTabProps) {
    const confirm = useConfirm()
    const [malwareTools, setMalwareTools] = useState<MalwareTool[]>([])
    const [isLoading, setIsLoading] = useState(true)
    const [search, setSearch] = useState('')
    const [showModal, setShowModal] = useState(false)
    const [editingItem, setEditingItem] = useState<MalwareTool | null>(null)
    const [isSubmitting, setIsSubmitting] = useState(false)
    const [copiedHash, setCopiedHash] = useState<string | null>(null)
    const [hosts, setHosts] = useState<CompromisedHost[]>([])

    const [form, setForm] = useState({
        file_name: '',
        file_path: '',
        md5: '',
        sha256: '',
        sha512: '',
        file_size: '',
        creation_time: '',
        modification_time: '',
        host_id: '',
        host: '',
        description: '',
        malware_family: '',
        threat_actor: '',
        is_tool: false,
        sandbox_report_url: '',
    })

    useEffect(() => {
        if (incidentId) {
            loadData()
        }
    }, [incidentId])

    const loadData = async () => {
        setIsLoading(true)
        try {
            const [malwareRes, hostsRes] = await Promise.all([
                api.get<{ items: MalwareTool[] }>(`/incidents/${incidentId}/malware`),
                api.get<{ items: CompromisedHost[] }>(`/incidents/${incidentId}/hosts`),
            ])
            setMalwareTools(malwareRes.items || [])
            setHosts(hostsRes.items || [])
        } catch (error) {
            console.error('Failed to load malware/tools:', error)
        } finally {
            setIsLoading(false)
        }
    }

    const resetForm = () => {
        setForm({
            file_name: '', file_path: '', md5: '', sha256: '', sha512: '', file_size: '',
            creation_time: '', modification_time: '', host_id: '', host: '',
            description: '', malware_family: '', threat_actor: '', is_tool: false, sandbox_report_url: ''
        })
        setEditingItem(null)
    }

    const handleOpenModal = (item?: MalwareTool) => {
        if (item) {
            setEditingItem(item)
            setForm({
                file_name: item.file_name,
                file_path: item.file_path || '',
                md5: item.md5 || '',
                sha256: item.sha256 || '',
                sha512: item.sha512 || '',
                file_size: item.file_size ? String(item.file_size) : '',
                creation_time: item.creation_time || '',
                modification_time: item.modification_time || '',
                host_id: item.host_id || '',
                host: item.host || '',
                description: item.description || '',
                malware_family: item.malware_family || '',
                threat_actor: item.threat_actor || '',
                is_tool: item.is_tool,
                sandbox_report_url: item.sandbox_report_url || '',
            })
        } else {
            resetForm()
        }
        setShowModal(true)
    }

    const handleSubmit = async () => {
        if (!form.file_name) return
        setIsSubmitting(true)
        try {
            const payload = {
                file_name: form.file_name,
                file_path: form.file_path || null,
                md5: form.md5 || null,
                sha256: form.sha256 || null,
                sha512: form.sha512 || null,
                file_size: form.file_size ? parseInt(form.file_size) : null,
                creation_time: form.creation_time || null,
                modification_time: form.modification_time || null,
                host_id: form.host_id || null,
                host: form.host || null,
                description: form.description || null,
                malware_family: form.malware_family || null,
                threat_actor: form.threat_actor || null,
                is_tool: form.is_tool,
                sandbox_report_url: form.sandbox_report_url || null,
            }

            if (editingItem) {
                await api.put(`/incidents/${incidentId}/malware/${editingItem.id}`, payload)
            } else {
                await api.post(`/incidents/${incidentId}/malware`, payload)
            }

            setShowModal(false)
            resetForm()
            loadData()
        } catch (error) {
            console.error('Failed to save malware:', error)
        } finally {
            setIsSubmitting(false)
        }
    }

    const handleDelete = async (id: string) => {
        const confirmed = await confirm({
            title: 'Delete Item',
            description: 'Are you sure you want to delete this malware/tool entry?',
            confirmLabel: 'Delete',
            variant: 'destructive',
        })
        if (!confirmed) return
        try {
            await api.delete(`/incidents/${incidentId}/malware/${id}`)
            loadData()
        } catch (error) {
            console.error('Failed to delete:', error)
        }
    }

    const copyToClipboard = (text: string, type: string) => {
        navigator.clipboard.writeText(text)
        setCopiedHash(type)
        setTimeout(() => setCopiedHash(null), 2000)
    }

    const filteredTools = malwareTools.filter(item =>
        item.file_name.toLowerCase().includes(search.toLowerCase()) ||
        item.malware_family?.toLowerCase().includes(search.toLowerCase()) ||
        item.description?.toLowerCase().includes(search.toLowerCase())
    )

    return (
        <div className="space-y-4">
            <Card>
                <CardContent className="p-4">
                    <div className="flex justify-between items-center">
                        <div className="relative w-72">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="Search malware & tools..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                                className="pl-10"
                                variant="glass"
                            />
                        </div>
                        <Button onClick={() => handleOpenModal()}>
                            <Plus className="mr-2 h-4 w-4" /> Add Item
                        </Button>
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardContent className="p-0">
                    <GlassTable className="border-0">
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead>Name/Path</TableHead>
                                    <TableHead>Type</TableHead>
                                    <TableHead>Hash</TableHead>
                                    <TableHead>Host Coorelation</TableHead>
                                    <TableHead>Size/Time</TableHead>
                                    <TableHead>Threat Info</TableHead>
                                    <TableHead className="w-[50px]"></TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {isLoading ? (
                                    <SkeletonTableRow columns={7} />
                                ) : filteredTools.length === 0 ? (
                                    <TableRow>
                                        <TableCell colSpan={7}>
                                            <TableEmpty title="No malware or tools found" icon={<Bug className="w-10 h-10" />} />
                                        </TableCell>
                                    </TableRow>
                                ) : (
                                    filteredTools.map(item => (
                                        <TableRow key={item.id} className="group">
                                            <TableCell>
                                                <div className="font-medium">{item.file_name}</div>
                                                <div className="text-xs text-muted-foreground truncate max-w-[200px]" title={item.file_path || ''}>{item.file_path || '-'}</div>
                                            </TableCell>
                                            <TableCell>
                                                <Badge variant={item.is_tool ? 'outline' : 'destructive'} className={item.is_tool ? '' : 'bg-red-500/10 text-red-500 border-red-500/20'}>
                                                    {item.is_tool ? <Wrench className="w-3 h-3 mr-1" /> : <Bug className="w-3 h-3 mr-1" />}
                                                    {item.is_tool ? 'Tool' : 'Malware'}
                                                </Badge>
                                            </TableCell>
                                            <TableCell>
                                                {item.md5 && (
                                                    <div className="flex items-center gap-1 text-xs font-mono bg-black/20 p-1 rounded w-fit">
                                                        MD5: {item.md5.substring(0, 8)}...
                                                        <Button variant="ghost" size="sm" className="h-4 w-4 p-0" onClick={() => copyToClipboard(item.md5!, item.id + 'md5')}>
                                                            {copiedHash === item.id + 'md5' ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                                                        </Button>
                                                    </div>
                                                )}
                                            </TableCell>
                                            <TableCell>
                                                {item.host_id ? hosts.find(h => h.id === item.host_id)?.hostname : item.host || '-'}
                                            </TableCell>
                                            <TableCell>
                                                <div className="text-xs">
                                                    <div>{item.file_size ? formatBytes(item.file_size) : '-'}</div>
                                                    <div className="text-muted-foreground">{item.creation_time ? formatDateTime(item.creation_time) : '-'}</div>
                                                </div>
                                            </TableCell>
                                            <TableCell>
                                                <div className="text-sm">{item.malware_family || '-'}</div>
                                                <div className="text-xs text-muted-foreground">{item.threat_actor || '-'}</div>
                                            </TableCell>
                                            <TableCell>
                                                <div className="flex items-center gap-1">
                                                    <Button variant="ghost" size="sm" className="opacity-0 group-hover:opacity-100" onClick={() => handleOpenModal(item)}>
                                                        <MoreHorizontal className="w-4 h-4" />
                                                    </Button>
                                                    <Button variant="ghost" size="sm" className="opacity-0 group-hover:opacity-100 text-destructive" onClick={() => handleDelete(item.id)}>
                                                        <Trash2 className="w-4 h-4" />
                                                    </Button>
                                                </div>
                                            </TableCell>
                                        </TableRow>
                                    ))
                                )}
                            </TableBody>
                        </Table>
                    </GlassTable>
                </CardContent>
            </Card>

            {/* Add/Edit Modal */}
            <Dialog open={showModal} onOpenChange={setShowModal}>
                <DialogContent className="max-w-2xl">
                    <DialogHeader>
                        <DialogTitle>Add Malware / Tool</DialogTitle>
                    </DialogHeader>
                    <DialogBody className="space-y-4 max-h-[60vh] overflow-y-auto w-full px-1">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label>File Name *</Label>
                                <Input value={form.file_name} onChange={e => setForm({ ...form, file_name: e.target.value })} placeholder="scvhost.exe" variant="glass" />
                            </div>
                            <div className="space-y-2">
                                <Label>File Path</Label>
                                <Input value={form.file_path} onChange={e => setForm({ ...form, file_path: e.target.value })} placeholder="C:\Windows\Temp\" variant="glass" />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <Label>Hashes</Label>
                            <div className="grid grid-cols-1 gap-2">
                                <Input value={form.md5} onChange={e => setForm({ ...form, md5: e.target.value })} placeholder="MD5" variant="glass" className="font-mono text-xs" />
                                <Input value={form.sha256} onChange={e => setForm({ ...form, sha256: e.target.value })} placeholder="SHA256" variant="glass" className="font-mono text-xs" />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label>Size (bytes)</Label>
                                <Input type="number" value={form.file_size} onChange={e => setForm({ ...form, file_size: e.target.value })} variant="glass" />
                            </div>
                            <div className="space-y-2">
                                <Label>Associated Host</Label>
                                <Select value={form.host_id} onValueChange={val => setForm({ ...form, host_id: val })}>
                                    <SelectTrigger variant="glass"><SelectValue placeholder="Select Host" /></SelectTrigger>
                                    <SelectContent>
                                        {hosts.map(h => <SelectItem key={h.id} value={h.id}>{h.hostname}</SelectItem>)}
                                    </SelectContent>
                                </Select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label>Creation Time</Label>
                                <Input type="datetime-local" value={form.creation_time} onChange={e => setForm({ ...form, creation_time: e.target.value })} variant="glass" />
                            </div>
                            <div className="space-y-2">
                                <Label>Modification Time</Label>
                                <Input type="datetime-local" value={form.modification_time} onChange={e => setForm({ ...form, modification_time: e.target.value })} variant="glass" />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label>Malware Family</Label>
                                <Input value={form.malware_family} onChange={e => setForm({ ...form, malware_family: e.target.value })} variant="glass" />
                            </div>
                            <div className="space-y-2">
                                <Label>Threat Actor</Label>
                                <Input value={form.threat_actor} onChange={e => setForm({ ...form, threat_actor: e.target.value })} variant="glass" />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <Label>Description</Label>
                            <Textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} variant="glass" />
                        </div>

                        <div className="flex items-center gap-2">
                            <input type="checkbox" checked={form.is_tool} onChange={e => setForm({ ...form, is_tool: e.target.checked })} className="rounded bg-white/10 border-white/20" />
                            <Label>Is this a Tool? (Not strictly malware)</Label>
                        </div>
                    </DialogBody>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setShowModal(false)}>Cancel</Button>
                        <Button onClick={handleSubmit} loading={isSubmitting}>{editingItem ? 'Save Changes' : 'Add Item'}</Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    )
}
